name: TestUtilities.CI - Build Only

on:
  push:
    branches:
      - "**" # trigger on push for all branches

  pull_request:
    branches:
      - "**" # trigger on PR for all branches

  workflow_dispatch:
    inputs:
      os:
        description: "Runner OS (comma-separated for multiple, e.g. ubuntu-latest,windows-latest)"
        type: string
        default: "ubuntu-latest"

jobs:
  get-params:
    name: Prepare the default and passed in parameters
    runs-on: ubuntu-latest
    if: >
      ${{
      github.event_name == 'pull_request' ||
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'push' && !contains(github.event.head_commit.message, '[skip ci]')
      }}
    outputs:
      build-projects: ${{ steps.init-params.outputs.build-projects }}
      os: ${{ steps.init-params.outputs.os }}
      dotnet-version: ${{ steps.init-params.outputs.dotnet-version }}
      configuration: ${{ steps.init-params.outputs.configuration }}
    steps:
      - name: Gather parameters
        id: init-params
        shell: bash
        run: |
          # Build the whole solution at once
          build_projects='[ "./vm2.TestUtilities.slnx" ]'

          # External variables
          dotnet_version=${{ vars.DOTNET_VERSION }}
          configuration=${{ vars.CONFIGURATION }}

          # Set defaults based on event type
          if [ "${{ github.event_name }}" == "push" ] || \
             [ "${{ github.event_name }}" == "pull_request" ]; then
              os='["ubuntu-latest"]'
          elif [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
              # Convert comma-separated runner OS values to JSON array
              os=$(echo "${{ inputs.os }}" | jq -Rc 'split(",") | map(select(length > 0) | gsub("^\\s+|\\s+$";""))')
          else
              echo "Unsupported event: ${{ github.event_name }}"
              exit 5
          fi

          # Set the outputs
          {
            echo "build-projects=${build_projects}"
            echo "os=${os}"
            echo "dotnet-version=${dotnet_version}"
            echo "configuration=${configuration}"
          }  >> $GITHUB_OUTPUT

  call-ci:
    uses: vmelamed/vm2.DevOps/.github/workflows/_ci.yaml@main
    needs:
      - get-params
    permissions:
      contents: read
      checks: write
      pull-requests: write
    with:
      os: ${{ needs.get-params.outputs.os }}
      dotnet-version: ${{ needs.get-params.outputs.dotnet-version }}
      configuration: ${{ needs.get-params.outputs.configuration }}
      preprocessor-symbols: ""
      build-projects: ${{ needs.get-params.outputs.build-projects }}
      test-projects: ""
      benchmark-projects: ""
